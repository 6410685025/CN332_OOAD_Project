{% extends "base.html" %}
{% block title %}My Work History{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Stats cards -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted fw-semibold">Total Job Completed</div>
            <div class="display-6 fw-bold">{{ total_completed }}</div>
            <div class="text-success small">â†‘ updated from system</div>
          </div>
          <div class="rounded-3 p-3 bg-success bg-opacity-10">
            <i class="bi bi-check2-circle fs-3 text-success"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted fw-semibold">Average rating</div>
            <div class="display-6 fw-bold">{{ avg_rating }} <span class="fs-6 text-muted">/5.0</span></div>
            <div>
              {% with r=avg_rating|floatformat:0 %}
                {% for i in "12345" %}
                  {% if forloop.counter <= r|add:"0" %}
                    <i class="bi bi-star-fill text-warning"></i>
                  {% else %}
                    <i class="bi bi-star text-warning"></i>
                  {% endif %}
                {% endfor %}
              {% endwith %}
            </div>
          </div>
          <div class="rounded-3 p-3 bg-warning bg-opacity-10">
            <i class="bi bi-star-fill fs-3 text-warning"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted fw-semibold">This month</div>
            <div class="display-6 fw-bold">{{ this_month_count }}</div>
            <div class="text-muted small">Jobs completed this month</div>
          </div>
          <div class="rounded-3 p-3 bg-primary bg-opacity-10">
            <i class="bi bi-calendar-event fs-3 text-primary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-12 col-lg-3">
          <label class="form-label fw-semibold">Search Job ID</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input name="q" value="{{ q }}" class="form-control" placeholder="Enter Job ID...">
          </div>
        </div>

        <div class="col-12 col-lg-3">
          <label class="form-label fw-semibold">Date range</label>
          <select name="date_range" class="form-select">
            <option value="30" {% if date_range == "30" %}selected{% endif %}>Last 30 Days</option>
            <option value="90" {% if date_range == "90" %}selected{% endif %}>Last 90 Days</option>
            <option value="all" {% if date_range == "all" %}selected{% endif %}>All time</option>
          </select>
        </div>

        <div class="col-12 col-lg-3">
          <label class="form-label fw-semibold">Rating</label>
          <select name="rating" class="form-select">
            <option value="ALL" {% if rating_filter == "ALL" %}selected{% endif %}>All Rating</option>
            <option value="5" {% if rating_filter == "5" %}selected{% endif %}>5</option>
            <option value="4" {% if rating_filter == "4" %}selected{% endif %}>4</option>
            <option value="3" {% if rating_filter == "3" %}selected{% endif %}>3</option>
            <option value="2" {% if rating_filter == "2" %}selected{% endif %}>2</option>
            <option value="1" {% if rating_filter == "1" %}selected{% endif %}>1</option>
          </select>
        </div>

        <div class="col-12 col-lg-3">
          <button class="btn btn-primary" type="submit">Apply</button>
          <a class="btn btn-outline-secondary" href="{% url 'technician_work_history' %}">Reset</a>
        </div>
      </form>
    </div>
  </div>

  <!-- List cards -->
  {% for r in repairs %}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex align-items-center gap-2">
            <h4 class="mb-0 fw-bold">Job #{{ r.id }}</h4>

            <span class="badge rounded-pill bg-success bg-opacity-10 text-success">
              <i class="bi bi-check-circle me-1"></i>Completed
            </span>

            {% if r.request_type == "MAINTENANCE" %}
              <span class="badge rounded-pill bg-warning bg-opacity-10 text-warning">
                <i class="bi bi-wrench-adjustable me-1"></i>Maintenance
              </span>
            {% else %}
              <span class="badge rounded-pill bg-info bg-opacity-10 text-info">
                <i class="bi bi-chat-left-text me-1"></i>Complaint
              </span>
            {% endif %}
          </div>

          <div class="d-flex align-items-center gap-3">
            <div class="text-end">
              <div>
                {% for i in "12345" %}
                  {% if r.rating and forloop.counter <= r.rating %}
                    <i class="bi bi-star-fill text-warning"></i>
                  {% else %}
                    <i class="bi bi-star text-warning"></i>
                  {% endif %}
                {% endfor %}
              </div>
              <div class="small text-muted">Rating: {{ r.rating|default:"-" }}</div>
            </div>

            <a class="btn btn-success rounded-pill px-4" href="{% url 'repair_detail' r.id %}">
              View Detail
            </a>
          </div>
        </div>

        <hr>

        <div class="text-muted small mb-2">
          <i class="bi bi-calendar3 me-1"></i>
          Completed on {{ r.created_at|date:"F d, Y" }}
        </div>
        <div class="text-muted small mb-3">
          <i class="bi bi-geo-alt me-1"></i>
          {{ r.location }}
        </div>

        <div class="text-muted">
          Issue: {{ r.description|truncatechars:160 }}
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-light border">No completed jobs found.</div>
  {% endfor %}

</div>
{% endblock %}
