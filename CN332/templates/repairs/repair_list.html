{% extends "base.html" %}

{% block page_title %}Repair / Requests{% endblock %}

{% block extra_css %}
<style>
  .repair-table-card {
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    border: none;
  }

  .repair-table {
    margin: 0;
  }

  .repair-table thead {
    background: #f8fafc;
  }

  .repair-table thead th {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 16px;
    border: none;
  }

  .repair-table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .repair-table tbody tr:hover {
    background-color: #f8fafc;
  }

  .repair-table tbody td {
    padding: 16px;
    vertical-align: middle;
    color: #1e293b;
    font-size: 0.9rem;
    border-bottom: 1px solid #f1f5f9;
  }

  .repair-table tbody tr:last-child td {
    border-bottom: none;
  }

  .request-id {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.95rem;
  }

  .type-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .type-badge.maintenance {
    background: #dbeafe;
    color: #1e40af;
  }

  .type-badge.complaint {
    background: #fed7aa;
    color: #c2410c;
  }

  .location-cell {
    line-height: 1.4;
  }

  .location-primary {
    font-weight: 500;
    color: #1e293b;
    display: block;
  }

  .location-secondary {
    font-size: 0.8rem;
    color: #94a3b8;
    display: block;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .status-badge.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .status-badge.on-process {
    background: #fef3c7;
    color: #92400e;
  }

  .status-badge.completed {
    background: #d1fae5;
    color: #065f46;
  }

  .technician-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #e0e7ff;
    color: #4338ca;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 8px;
  }

  .technician-name {
    color: #1e293b;
    font-size: 0.9rem;
  }

  .search-input-group .input-group-text {
    background: white;
    border-right: 0;
    border-color: #e2e8f0;
  }

  .search-input-group .form-control {
    border-left: 0;
    border-color: #e2e8f0;
  }

  .search-input-group .form-control:focus {
    border-color: #e2e8f0;
    box-shadow: none;
  }

  .btn-new-request {
    background: #2563eb;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    color: white;
  }

  .btn-new-request:hover {
    background: #1d4ed8;
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
  <div>
    <h2 class="mb-0" style="font-size: 1.75rem; font-weight: 600; color: #1e293b;">
      <i class="bi bi-wrench me-2"></i>Repair / Requests
    </h2>
  </div>
  {% if user.is_resident %}
  <a href="{% url 'create_repair' %}" class="btn btn-new-request">
    <i class="bi bi-plus-lg me-2"></i>New Request
  </a>
  {% endif %}
</div>

<div class="d-flex gap-2 mb-3">
  <form method="get" class="d-flex flex-grow-1 gap-2" role="search">
    <div class="input-group search-input-group flex-grow-1" style="max-width: 400px;">
      <span class="input-group-text"><i class="bi bi-search text-muted"></i></span>
      <input type="search" name="q" class="form-control" placeholder="Search by ID, location, or type..." value="{{ request.GET.q }}">
    </div>
    <button type="button" class="btn btn-outline-secondary">
      <i class="bi bi-funnel me-1"></i>Filter
    </button>
  </form>
</div>

<div class="card repair-table-card">
  <div class="card-body p-0 overflow-auto">
    <table class="table repair-table mb-0">
      <thead>
        <tr>
          <th>REQUEST ID</th>
          <th>TYPE</th>
          <th>DESCRIPTION</th>
          <th>STATUS</th>
          <th>TECHNICIAN</th>
        </tr>
      </thead>
      <tbody>
        {% for repair in repairs %}
        <tr onclick="window.location.href='{% url 'repair_detail' repair.pk %}'">
          <td>
            <span class="request-id">REQ-{{ repair.id|stringformat:"04d" }}</span>
          </td>
          <td>
            <span class="type-badge {% if repair.request_type == 'COMPLAINT' %}complaint{% else %}maintenance{% endif %}">
              <i class="bi bi-{% if repair.request_type == 'COMPLAINT' %}exclamation-triangle-fill{% else %}wrench{% endif %}"></i>
              {{ repair.get_request_type_display }}
            </span>
          </td>
          <td>
            <div class="location-cell">
              <span class="location-primary">{{ repair.description|truncatewords:8|default:"No description" }}</span>
            </div>
          </td>
          <td>
            <span class="status-badge {% if repair.status == 'COMPLETED' %}completed{% elif repair.status == 'ON_PROCESS' %}on-process{% else %}pending{% endif %}">
              <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i>
              {{ repair.get_status_display }}
            </span>
          </td>
          <td>
            {% if repair.technician %}
            <div class="d-flex align-items-center">
              <span class="technician-avatar">{{ repair.technician.user.get_full_name|default:repair.technician.user.username|slice:":1"|upper }}</span>
              <span class="technician-name">{{ repair.technician.user.get_full_name|default:repair.technician.user.username }}</span>
            </div>
            {% elif repair.assigned_staff %}
            <div class="d-flex align-items-center">
              <span class="technician-avatar">{{ repair.assigned_staff.user.get_full_name|default:repair.assigned_staff.user.username|slice:":1"|upper }}</span>
              <span class="technician-name">{{ repair.assigned_staff.user.get_full_name|default:repair.assigned_staff.user.username }}</span>
            </div>
            {% else %}
            <span class="text-muted" style="font-size: 0.85rem;">Unassigned</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1;"></i>
            <p class="text-muted mt-2 mb-0">No repair requests found</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
