{% extends "base.html" %}

{% block page_title %}Repair / Requests{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
  <div class="d-flex align-items-center gap-2 flex-grow-1">
    <h2 class="mb-0"><i class="bi bi-wrench me-2"></i>Repair / Requests</h2>
    {% if user.is_resident %}
    <a href="{% url 'create_repair' %}" class="btn btn-primary btn-sm ms-2"><i class="bi bi-plus me-1"></i>New Request</a>
    {% endif %}
  </div>
</div>

<div class="d-flex gap-2 mb-3">
  <form method="get" class="d-flex flex-grow-1 gap-2" role="search">
    <div class="input-group flex-grow-1">
      <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
      <input type="search" name="q" class="form-control border-start-0" placeholder="Search by ID, location, or type..." value="{{ request.GET.q }}">
    </div>
    <button type="button" class="btn btn-outline-secondary"><i class="bi bi-funnel me-1"></i>Filter</button>
  </form>
</div>

<div class="card">
  <div class="card-body p-0 overflow-auto">
    <table class="table mb-0">
      <thead>
        <tr>
          <th>Request ID</th>
          <th>Type</th>
          <th>Location</th>
          <th>Status</th>
          <th>Technician</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for repair in repairs %}
        <tr>
          <td><strong>REQ-{{ repair.id }}</strong></td>
          <td>
            <span class="badge-pill {% if repair.request_type == 'COMPLAINT' %}bg-warning{% else %}bg-info{% endif %}">
              <i class="bi bi-{% if repair.request_type == 'COMPLAINT' %}exclamation-triangle{% else %}wrench{% endif %} me-1"></i>
              {{ repair.get_request_type_display }}
            </span>
          </td>
          <td>{{ repair.location }}</td>
          <td>
            <span class="badge-pill {% if repair.status == 'COMPLETED' %}bg-success{% elif repair.status == 'ON_PROCESS' %}bg-warning{% else %}bg-warning{% endif %}">
              <i class="bi bi-{% if repair.status == 'COMPLETED' %}check-circle{% else %}arrow-repeat{% endif %} me-1"></i>
              {{ repair.get_status_display }}
            </span>
          </td>
          <td>
            {% if repair.technician %}
            <i class="bi bi-person me-1"></i>{{ repair.technician.user.get_full_name|default:repair.technician.user.username }}
            {% else %}
            <span class="text-muted">Unassigned</span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'repair_detail' repair.pk %}" class="btn btn-sm btn-outline-secondary">View</a>
            {% if user.is_staff_member and repair.status == 'PENDING' and not repair.technician %}
            <a href="{% url 'assign_technician' repair.pk %}" class="btn btn-sm btn-primary">Assign Technician</a>
            {% endif %}
            {% if user.is_technician and repair.technician.user_id == user.id and repair.status != 'COMPLETED' %}
            <a href="{% url 'update_repair_status' repair.pk %}" class="btn btn-sm btn-info">Update</a>
            {% endif %}
            {% if user.is_resident and repair.status == 'COMPLETED' and not repair.rating %}
            <a href="{% url 'rate_repair' repair.pk %}" class="btn btn-sm btn-warning">Rate</a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center py-5 text-muted">No repair requests found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
