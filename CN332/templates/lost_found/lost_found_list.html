{% extends "base.html" %}

{% block page_title %}Lost & Found{% endblock %}

{% block extra_css %}
<style>
    .lostfound-page {
        padding: 8px 4px 24px;
    }

    .lostfound-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .lostfound-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.7rem;
        font-weight: 700;
    }

    .btn-report-new {
        background: #5b5bff;
        color: #fff;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
    }

    .btn-report-new:hover {
        background: #4f46e5;
        color: #fff;
    }

    /* RESIDENT VIEW - CARD LAYOUT */
    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .item-card {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .item-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .item-image-container {
        position: relative;
        width: 100%;
        height: 180px;
        background: #f0f0f0;
        overflow: hidden;
    }

    .item-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-badges {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .item-badges .badge-pending {
        margin-left: auto;
    }

    .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-lost {
        background: #ef4444;
        color: #fff;
    }

    .badge-found {
        background: #10b981;
        color: #fff;
    }

    .badge-pending {
        background: #fbbf24;
        color: #78350f;
    }

    .badge-resolved {
        background: #10b981;
        color: #fff;
    }

    .item-content {
        padding: 16px;
    }

    .item-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1e293b;
        line-height: 1.4;
    }

    .item-description {
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 12px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .item-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        color: #9ca3af;
        margin-bottom: 12px;
    }

    .item-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .item-action-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        background: #5b5bff;
        color: #fff;
        transition: background 0.2s;
    }

    .item-action-btn:hover {
        background: #4f46e5;
    }

    .item-action-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        color: #6b7280;
    }

    .item-status-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 4px;
        margin-top: 8px;
    }

    .status-claimed {
        background: #dcfce7;
        color: #15803d;
    }

    .status-resolved {
        background: #dbeafe;
        color: #0c4a6e;
    }

    /* STAFF VIEW - TABLE LAYOUT */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        background: #fff;
    }

    .stat-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
    }

    .stat-value.grey {
        color: #6b7280;
    }

    .stat-value.orange {
        color: #f97316;
    }

    .stat-value.green {
        color: #10b981;
    }

    .filters-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 18px;
        align-items: center;
    }

    .search-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px 12px;
        flex: 1;
        min-width: 250px;
    }

    .search-bar input {
        border: none;
        outline: none;
        width: 100%;
        font-size: 0.9rem;
    }

    .filter-btn {
        border: 1px solid #e5e7eb;
        background: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
        cursor: pointer;
        white-space: nowrap;
    }

    .filter-btn.active {
        background: #f1f5f9;
        color: #334155;
    }

    .lostfound-table {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }

    .lostfound-table table {
        width: 100%;
        margin: 0;
    }

    .lostfound-table thead {
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }

    .lostfound-table th {
        padding: 12px 16px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        text-align: left;
    }

    .lostfound-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .lostfound-table tr:last-child td {
        border-bottom: none;
    }

    .lostfound-table tbody tr:hover {
        background: #f8fafc;
    }

    .item-id {
        font-weight: 600;
        color: #1e293b;
    }

    .person-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .person-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e0e7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #4f46e5;
        font-size: 0.85rem;
    }

    .person-name {
        font-weight: 500;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }

    .status-resolved {
        background: #dcfce7;
        color: #15803d;
    }

    .action-btns {
        display: flex;
        gap: 6px;
    }

    .action-btn {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        text-decoration: none;
        display: inline-block;
    }

    .btn-review {
        background: #e0e7ff;
        color: #4f46e5;
    }

    .btn-review:hover {
        background: #c7d2fe;
    }

    .btn-resolve {
        background: #10b981;
        color: #fff;
    }

    .btn-resolve:hover {
        background: #059669;
    }

    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        font-size: 0.85rem;
        color: #6b7280;
    }

    .pagination-controls {
        display: flex;
        gap: 6px;
    }

    .page-btn {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        color: #1e293b;
        display: inline-block;
    }

    .page-btn.active {
        background: #4f46e5;
        color: #fff;
        border-color: #4f46e5;
    }

    .page-btn:hover:not(.active):not(:disabled) {
        background: #f8fafc;
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="lostfound-page">
  {% if user.is_staff_member %}
  <!-- STAFF VIEW - TABLE LAYOUT -->
  <div class="lostfound-header">
    <div class="lostfound-title"><i class="bi bi-search"></i>Lost & Found Management</div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">
        <i class="bi bi-inbox"></i>Total Item
      </div>
      <div class="stat-value grey">{{ total_items }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        <i class="bi bi-clock-history"></i>Review Pending
      </div>
      <div class="stat-value orange">{{ review_pending }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        <i class="bi bi-check-circle"></i>Resolve
      </div>
      <div class="stat-value green">{{ resolved_count }}</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-row">
    <div class="search-bar">
      <i class="bi bi-search"></i>
      <input type="text" id="searchInput" placeholder="Search by ID, location, or type...">
    </div>
    <button class="filter-btn active" data-filter="all">All Item</button>
    <button class="filter-btn" data-filter="pending">Pending</button>
    <button class="filter-btn" data-filter="resolved">Resolved</button>
  </div>

  <!-- Lost & Found Table -->
  <div class="lostfound-table">
    <table>
      <thead>
        <tr>
          <th>ITEM ID</th>
          <th>FULL NAME</th>
          <th>DESCRIPTION</th>
          <th>LOCATION</th>
          <th>STATUS</th>
          <th>ACTION</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr data-status="{{ item.status }}">
          <td class="item-id">LF-{{ item.id|stringformat:"04d" }}</td>
          <td>
            <div class="person-info">
              <div class="person-avatar">{{ item.reporter.user.first_name.0|default:"U" }}{{ item.reporter.user.last_name.0|default:"" }}</div>
              <span class="person-name">{{ item.reporter.user.get_full_name|default:item.reporter.user.username }}</span>
            </div>
          </td>
          <td>{{ item.item_name }}</td>
          <td>{{ item.location }}</td>
          <td>
            {% if item.status == 'PENDING' %}
            <span class="status-badge status-pending">
              <i class="bi bi-clock"></i>Review Pending
            </span>
            {% elif item.status == 'CLAIMED' %}
            <span class="status-badge status-pending">
              <i class="bi bi-clock"></i>Review Pending
            </span>
            {% else %}
            <span class="status-badge status-resolved">
              <i class="bi bi-check-circle"></i>Resolved
            </span>
            {% endif %}
          </td>
          <td>
            <div class="action-btns">
              {% if not item.is_approved %}
              <a href="{% url 'approve_item' item.pk %}" class="action-btn btn-review">Approve</a>
              {% elif item.item_type == 'FOUND' %}
              <a href="{% url 'resolve_item' item.pk %}" class="action-btn btn-resolve">Mark Resolved</a>
              {% elif item.status == 'CLAIMED' %}
              <a href="{% url 'resolve_item' item.pk %}" class="action-btn btn-resolve">Mark Resolved</a>
              {% elif item.status == 'PENDING' %}
              <button class="action-btn btn-review" disabled style="opacity: 0.5; cursor: not-allowed;">Waiting for Claim</button>
              {% else %}
              <button class="action-btn btn-review" disabled style="opacity: 0.5; cursor: not-allowed;">Resolved</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center py-4 text-muted">No items found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div>Showing {{ items.start_index }} to {{ items.end_index }} of {{ items.paginator.count }} results</div>
    <div class="pagination-controls">
      {% if items.has_previous %}
      <a href="?page={{ items.previous_page_number }}" class="page-btn"><i class="bi bi-chevron-left"></i></a>
      {% else %}
      <button class="page-btn" disabled><i class="bi bi-chevron-left"></i></button>
      {% endif %}
      
      {% for num in items.paginator.page_range %}
        {% if items.number == num %}
        <a href="?page={{ num }}" class="page-btn active">{{ num }}</a>
        {% elif num > items.number|add:'-3' and num < items.number|add:'3' %}
        <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
        {% endif %}
      {% endfor %}
      
      {% if items.has_next %}
      <a href="?page={{ items.next_page_number }}" class="page-btn"><i class="bi bi-chevron-right"></i></a>
      {% else %}
      <button class="page-btn" disabled><i class="bi bi-chevron-right"></i></button>
      {% endif %}
    </div>
  </div>

  {% else %}
  <!-- RESIDENT VIEW - CARD LAYOUT -->
  <div class="lostfound-header">
    <div class="lostfound-title"><i class="bi bi-search"></i>Lost & Found</div>
    <a href="{% url 'report_item' %}" class="btn-report-new">
      <i class="bi bi-plus-lg me-2"></i>+ Report New Item
    </a>
  </div>

  <!-- Filters -->
  <div class="filters-row">
    <div class="search-bar">
      <i class="bi bi-search"></i>
      <input type="text" id="searchInput" placeholder="Search by ID, location, or type...">
    </div>
    <button class="filter-btn active" data-filter="all">All Item</button>
    <button class="filter-btn" data-filter="lost">Lost</button>
    <button class="filter-btn" data-filter="found">Found</button>
    <button class="filter-btn" data-filter="filters"><i class="bi bi-funnel"></i>Filters</button>
  </div>

  <!-- Items Grid -->
  <div class="items-grid">
    {% for item in items %}
    <div class="item-card" data-type="{{ item.item_type|lower }}" data-status="{{ item.status }}">
      <div class="item-image-container">
        {% if item.image %}
        <img src="{{ item.image.url }}" alt="{{ item.item_name }}" class="item-image">
        {% else %}
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: #9ca3af;">
          <i class="bi bi-image" style="font-size: 3rem;"></i>
        </div>
        {% endif %}
        
        <div class="item-badges">
          <span class="badge {% if item.item_type == 'LOST' %}badge-lost{% else %}badge-found{% endif %}">
            {{ item.item_type }}
          </span>
          {% if item.status == 'PENDING' %}
          <span class="badge badge-pending">
            <i class="bi bi-clock"></i>PENDING
          </span>
          {% elif item.status == 'RESOLVED' %}
          <span class="badge badge-resolved">
            <i class="bi bi-check-circle"></i>RESOLVED
          </span>
          {% endif %}
        </div>
      </div>

      <div class="item-content">
        <div class="item-title">{{ item.item_name }}</div>
        <div class="item-description">{{ item.description|truncatewords:15 }}</div>
        
        <div class="item-meta">
          <div class="item-meta-item">
            <i class="bi bi-geo-alt"></i>{{ item.location }}
          </div>
          <div class="item-meta-item">
            <i class="bi bi-clock"></i>
            {% if item.reported_at %}
              {% with days=item.reported_at|timesince %}
                {% if "minute" in days %}a few moments ago{% elif "hour" in days %}{{ days|slice:":-7" }}h ago{% else %}{{ days|slice:":-5" }}d ago{% endif %}
              {% endwith %}
            {% endif %}
          </div>
        </div>

        {% if item.status == 'CLAIMED' %}
        <div class="item-status-badge status-claimed">
          <i class="bi bi-check-circle"></i>Reunited with owner
        </div>
        {% elif item.status == 'RESOLVED' %}
        <div class="item-status-badge status-resolved">
          <i class="bi bi-check-circle"></i>Item resolved successfully
        </div>
        {% elif item.status == 'PENDING' %}
          {% if item.item_type == 'LOST' %}
          <button class="item-action-btn" onclick="window.location.href='{% url 'claim_item' item.pk %}';">I Found This</button>
          {% else %}
          <button class="item-action-btn" onclick="window.location.href='{% url 'claim_item' item.pk %}';">Claim Ownership</button>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {% empty %}
    <div style="grid-column: 1/-1; text-align: center; padding: 40px 20px; color: #9ca3af;">
      <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 16px;"></i>
      <p>No items found</p>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if items.paginator.num_pages > 1 %}
  <div class="pagination" style="margin-top: 32px;">
    <div style="margin: 0 auto;">Showing {{ items.start_index }} to {{ items.end_index }} of {{ items.paginator.count }} results</div>
    <div class="pagination-controls" style="margin: 16px auto; justify-content: center;">
      {% if items.has_previous %}
      <a href="?page={{ items.previous_page_number }}" class="page-btn"><i class="bi bi-chevron-left"></i></a>
      {% else %}
      <button class="page-btn" disabled><i class="bi bi-chevron-left"></i></button>
      {% endif %}
      
      {% for num in items.paginator.page_range %}
        {% if items.number == num %}
        <a href="?page={{ num }}" class="page-btn active">{{ num }}</a>
        {% elif num > items.number|add:'-3' and num < items.number|add:'3' %}
        <a href="?page={{ num }}" class="page-btn">{{ num }}</a>
        {% endif %}
      {% endfor %}
      
      {% if items.has_next %}
      <a href="?page={{ items.next_page_number }}" class="page-btn"><i class="bi bi-chevron-right"></i></a>
      {% else %}
      <button class="page-btn" disabled><i class="bi bi-chevron-right"></i></button>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.filter-btn[data-filter]');
    const searchInput = document.getElementById('searchInput');
    const tableRows = document.querySelectorAll('.lostfound-table tbody tr[data-status]');
    const itemCards = document.querySelectorAll('.item-card[data-type]');

    function filterTable() {
        const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
        const searchTerm = searchInput.value.toLowerCase();

        // Staff table filtering
        tableRows.forEach(row => {
            const status = row.dataset.status;
            const text = row.textContent.toLowerCase();

            let statusMatch = activeFilter === 'all' || 
                            (activeFilter === 'pending' && (status === 'PENDING' || status === 'CLAIMED')) ||
                            (activeFilter === 'resolved' && status === 'RESOLVED');

            let searchMatch = text.includes(searchTerm);

            row.style.display = statusMatch && searchMatch ? '' : 'none';
        });

        // Resident card filtering
        itemCards.forEach(card => {
            const type = card.dataset.type;
            const text = card.textContent.toLowerCase();

            let typeMatch = activeFilter === 'all' || 
                           (activeFilter === 'lost' && type === 'lost') ||
                           (activeFilter === 'found' && type === 'found') ||
                           (activeFilter === 'filters');

            let searchMatch = text.includes(searchTerm);

            card.style.display = typeMatch && searchMatch ? '' : 'none';
        });
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            filterTable();
        });
    });

    searchInput.addEventListener('input', filterTable);
});
</script>
{% endblock %}