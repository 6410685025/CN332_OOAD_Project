{% extends "base.html" %}

{% block page_title %}Check Availability{% endblock %}

{% block extra_css %}
<style>
  .booking-wrapper {
    max-width: 720px;
    margin: 0 auto;
  }

  .booking-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
    padding: 24px;
  }

  .booking-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .booking-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0;
  }

  .month-nav {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #475569;
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    text-align: center;
    font-size: 0.9rem;
  }

  .calendar .day-name {
    font-weight: 600;
    color: #64748b;
    padding: 6px 0;
  }

  .calendar .day-cell {
    padding: 8px 0;
    border-radius: 8px;
    cursor: pointer;
    color: #0f172a;
  }

  .calendar .day-cell.muted {
    color: #cbd5e1;
    cursor: default;
  }

  .calendar .day-cell.selected {
    background: #4f46e5;
    color: #fff;
    font-weight: 600;
  }

  .calendar .day-cell:hover:not(.muted) {
    background: #eef2ff;
  }

  .slots-title {
    font-weight: 700;
    margin: 24px 0 12px;
  }

  .slots-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(120px, 1fr));
    gap: 10px;
  }

  .slot-btn {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 8px 10px;
    background: #fff;
    font-weight: 600;
    color: #475569;
  }

  .slot-btn.selected {
    background: #4f46e5;
    color: #fff;
    border-color: #4f46e5;
  }

  .slot-btn.disabled {
    background: #f1f5f9;
    color: #94a3b8;
    border-color: #e2e8f0;
    cursor: not-allowed;
  }

  .hidden-field {
    display: none;
  }

  .action-row {
    margin-top: 24px;
    display: flex;
    gap: 12px;
  }
</style>
{% endblock %}

{% block content %}
<div class="booking-wrapper">
  <form method="post">
    {% csrf_token %}
    <div class="booking-card">
      <div class="mb-3">
        <label class="form-label fw-semibold">Facility</label>
        {{ form.facility }}
      </div>
      <div class="booking-header">
        <h2 class="booking-title">Select Date &amp; Time</h2>
        <div class="month-nav" id="monthNav"></div>
      </div>

      <div class="calendar" id="calendar"></div>

      <div class="hidden-field">
        {{ form.booking_date }}
        {{ form.time_slot }}
      </div>

      <div class="slots-title">Available Time Slots</div>
      <div class="slots-grid" id="slotsGrid">
        {% for slot in time_slots %}
          <button type="button" class="slot-btn {% if slot.value in booked_slots %}disabled{% endif %}" data-slot="{{ slot.value }}" {% if slot.value in booked_slots %}disabled{% endif %}>
            {{ slot.label }}
          </button>
        {% endfor %}
      </div>

      <div class="action-row">
        <button type="submit" class="btn btn-primary px-4">Confirm Booking</button>
        <a href="{% url 'facility_list' %}" class="btn btn-outline-secondary">Cancel</a>
      </div>
    </div>
  </form>
</div>

<script>
  const dateInput = document.querySelector('input[name="booking_date"]');
  const timeInput = document.querySelector('select[name="time_slot"]');
  const calendar = document.getElementById('calendar');
  const monthNav = document.getElementById('monthNav');
  const slotsGrid = document.getElementById('slotsGrid');

  const selectedDateValue = "{{ selected_date|default:'' }}";
  if (selectedDateValue) {
    dateInput.value = selectedDateValue;
  }

  function buildCalendar(date) {
    const current = date ? new Date(date) : new Date();
    const month = current.getMonth();
    const year = current.getFullYear();

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    monthNav.textContent = `${current.toLocaleString('default', { month: 'long' })} ${year}`;

    calendar.innerHTML = '';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(name => {
      const div = document.createElement('div');
      div.className = 'day-name';
      div.textContent = name;
      calendar.appendChild(div);
    });

    for (let i = 0; i < startDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'day-cell muted';
      calendar.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.textContent = day;
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      if (dateInput.value === dateStr) {
        cell.classList.add('selected');
      }
      cell.addEventListener('click', () => {
        dateInput.value = dateStr;
        const facilitySelect = document.querySelector('select[name="facility"]');
        const params = new URLSearchParams();
        if (facilitySelect.value) params.set('facility', facilitySelect.value);
        params.set('date', dateStr);
        window.location.search = params.toString();
      });
      calendar.appendChild(cell);
    }
  }

  buildCalendar(dateInput.value || selectedDateValue);

  slotsGrid.querySelectorAll('.slot-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.classList.contains('disabled')) return;
      slotsGrid.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      if (timeInput) {
        timeInput.value = btn.dataset.slot;
      }
    });
  });

  if (timeInput && timeInput.value) {
    const selected = slotsGrid.querySelector(`[data-slot="${timeInput.value}"]`);
    if (selected) selected.classList.add('selected');
  }
</script>
{% endblock %}