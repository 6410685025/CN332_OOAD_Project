{% extends "base.html" %}

{% block page_title %}Residents{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>Residents Management</h2>
    <p class="text-secondary mb-0">View resident directory</p>
  </div>
  <button type="button" class="btn btn-primary" onclick="openResidentModal()">
    <i class="bi bi-plus-circle"></i> Create Resident
  </button>
</div>

<div class="card">
  <div class="card-body p-0">
    <table class="table mb-0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Building</th>
          <th>Floor</th>
          <th>Room</th>
          <th>Contact</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="residents-table-body">
        {% for r in residents %}
        <tr>
          <td>{{ r.user.get_full_name|default:r.user.username }}</td>
          <td>{{ r.building }}</td>
          <td>{{ r.floor }}</td>
          <td>{{ r.room_number }}</td>
          <td>{{ r.user.email|default:"â€”" }}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editResident({{ r.id }})">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteResident({{ r.id }})">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center py-5 text-muted">No residents</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create Resident Modal -->
<div id="residentModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Create New Resident</h5>
        <button type="button" class="btn-close" onclick="closeResidentModal()"></button>
      </div>
      <div class="modal-body">
        <form id="residentForm">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="firstName" class="form-label">First Name *</label>
                <input type="text" class="form-control" id="firstName" name="first_name" required>
                <div class="invalid-feedback" id="firstName-error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name *</label>
                <input type="text" class="form-control" id="lastName" name="last_name" required>
                <div class="invalid-feedback" id="lastName-error"></div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email *</label>
            <input type="email" class="form-control" id="email" name="email" required>
            <div class="invalid-feedback" id="email-error"></div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="username" class="form-label">Username *</label>
                <input type="text" class="form-control" id="username" name="username" required>
                <div class="invalid-feedback" id="username-error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="contactNumber" class="form-label">Contact Number</label>
                <input type="tel" class="form-control" id="contactNumber" name="contact_number">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="password" class="form-label">Password *</label>
                <input type="password" class="form-control" id="password" name="password" required>
                <div class="invalid-feedback" id="password-error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="passwordConfirm" class="form-label">Confirm Password *</label>
                <input type="password" class="form-control" id="passwordConfirm" name="password_confirm" required>
                <div class="invalid-feedback" id="password_confirm-error"></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="building" class="form-label">Building *</label>
                <input type="text" class="form-control" id="building" name="building" placeholder="e.g., Building A" required>
                <div class="invalid-feedback" id="building-error"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="floor" class="form-label">Floor *</label>
                <input type="number" class="form-control" id="floor" name="floor" required>
                <div class="invalid-feedback" id="floor-error"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="roomNumber" class="form-label">Room Number *</label>
                <input type="text" class="form-control" id="roomNumber" name="room_number" required>
                <div class="invalid-feedback" id="room_number-error"></div>
              </div>
            </div>
          </div>

          <div id="formError" class="alert alert-danger d-none" role="alert"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeResidentModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitResidentForm()">
          <span id="submitBtn">Create Resident</span>
          <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
      <input type="hidden" id="residentIdEdit" name="resident_id" value="">
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div id="residentModalBackdrop" class="modal-backdrop fade" style="display: none;"></div>

<style>
  #residentModal {
    background-color: rgba(0, 0, 0, 0.5);
  }

  #residentModal.show {
    display: block;
  }

  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100%;
    height: 100%;
    background-color: #000;
    opacity: 0.5;
  }
</style>

<script>
  let editingResidentId = null;

  function openResidentModal() {
    editingResidentId = null;
    document.getElementById('modalTitle').textContent = 'Create New Resident';
    document.getElementById('submitBtn').textContent = 'Create Resident';
    document.getElementById('password').parentElement.parentElement.parentElement.style.display = 'block';
    document.getElementById('residentForm').reset();
    document.getElementById('formError').classList.add('d-none');
    document.getElementById('residentModal').classList.add('show');
    document.getElementById('residentModalBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function editResident(residentId) {
    editingResidentId = residentId;
    document.getElementById('modalTitle').textContent = 'Edit Resident';
    document.getElementById('submitBtn').textContent = 'Update Resident';
    document.getElementById('password').parentElement.parentElement.parentElement.style.display = 'none';
    document.getElementById('residentIdEdit').value = residentId;
    document.getElementById('formError').classList.add('d-none');
    document.getElementById('residentModal').classList.add('show');
    document.getElementById('residentModalBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Fetch resident data
    fetch(`{% url 'get_resident' 0 %}`.replace('0', residentId))
      .then(response => response.json())
      .then(data => {
        document.getElementById('firstName').value = data.user.first_name;
        document.getElementById('lastName').value = data.user.last_name;
        document.getElementById('email').value = data.user.email;
        document.getElementById('username').value = data.user.username;
        document.getElementById('contactNumber').value = data.contact_number || '';
        document.getElementById('building').value = data.building;
        document.getElementById('floor').value = data.floor;
        document.getElementById('roomNumber').value = data.room_number;
      })
      .catch(error => console.error('Error fetching resident:', error));
  }

  function deleteResident(residentId) {
    if (confirm('Are you sure you want to delete this resident? This action cannot be undone.')) {
      fetch(`{% url 'delete_resident' 0 %}`.replace('0', residentId), {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove row from table
          const rows = document.getElementById('residents-table-body').querySelectorAll('tr');
          rows.forEach(row => {
            if (row.textContent.includes(data.resident_name)) {
              row.remove();
            }
          });
          showSuccessMessage('Resident deleted successfully');
        } else {
          alert('Error deleting resident: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => alert('Error: ' + error));
    }
  }

  function closeResidentModal() {
    document.getElementById('residentModal').classList.remove('show');
    document.getElementById('residentModalBackdrop').style.display = 'none';
    document.body.style.overflow = 'auto';
    clearErrors();
  }

  function clearErrors() {
    document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
    document.getElementById('formError').classList.add('d-none');
    document.getElementById('residentForm').classList.remove('was-validated');
  }

  function submitResidentForm() {
    const form = document.getElementById('residentForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitSpinner = document.getElementById('submitSpinner');

    // Validate required fields
    if (!form.checkValidity() && !editingResidentId) {
      form.classList.add('was-validated');
      return;
    }

    submitBtn.style.display = 'none';
    submitSpinner.classList.remove('d-none');

    const url = editingResidentId 
      ? `{% url 'update_resident' 0 %}`.replace('0', editingResidentId)
      : '{% url "create_resident" %}';
    
    if (editingResidentId) {
      // For PUT request, send JSON data
      const data = {
        'first_name': document.getElementById('firstName').value,
        'last_name': document.getElementById('lastName').value,
        'email': document.getElementById('email').value,
        'contact_number': document.getElementById('contactNumber').value,
        'building': document.getElementById('building').value,
        'floor': document.getElementById('floor').value,
        'room_number': document.getElementById('roomNumber').value
      };

      fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateResidentInTable(data.resident);
          showSuccessMessage('Resident updated successfully');
          closeResidentModal();
        } else {
          document.getElementById('formError').textContent = data.error || 'An error occurred';
          document.getElementById('formError').classList.remove('d-none');
        }
      })
      .catch(error => {
        document.getElementById('formError').textContent = 'An error occurred: ' + error;
        document.getElementById('formError').classList.remove('d-none');
      })
      .finally(() => {
        submitBtn.style.display = 'inline-block';
        submitSpinner.classList.add('d-none');
      });
    } else {
      // For POST request, send FormData
      const formData = new FormData(form);

      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          addResidentToTable(data.resident);
          showSuccessMessage('Resident created successfully');
          closeResidentModal();
        } else {
          showFormErrors(data.errors || {'error': data.error});
          document.getElementById('formError').textContent = data.error || 'An error occurred';
          document.getElementById('formError').classList.remove('d-none');
        }
      })
      .catch(error => {
        document.getElementById('formError').textContent = 'An error occurred: ' + error;
        document.getElementById('formError').classList.remove('d-none');
      })
      .finally(() => {
        submitBtn.style.display = 'inline-block';
        submitSpinner.classList.add('d-none');
      });
    }
  }

  function showFormErrors(errors) {
    clearErrors();
    for (const [field, messages] of Object.entries(errors)) {
      const errorElement = document.getElementById(field + '-error');
      if (errorElement && messages.length > 0) {
        errorElement.textContent = messages[0];
      }
    }
  }

  function addResidentToTable(resident) {
    const tbody = document.getElementById('residents-table-body');
    
    // Clear empty state if exists
    const emptyRow = tbody.querySelector('tr td[colspan="6"]');
    if (emptyRow) {
      emptyRow.parentElement.remove();
    }

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td>${resident.user.first_name} ${resident.user.last_name}</td>
      <td>${resident.building}</td>
      <td>${resident.floor}</td>
      <td>${resident.room_number}</td>
      <td>${resident.user.email}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" onclick="editResident(${resident.id})">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteResident(${resident.id})">
          <i class="bi bi-trash"></i> Delete
        </button>
      </td>
    `;
    tbody.appendChild(newRow);
  }

  function updateResidentInTable(resident) {
    const tbody = document.getElementById('residents-table-body');
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length > 0 && cells[0].textContent.trim() === document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value) {
        cells[0].textContent = `${resident.user.first_name} ${resident.user.last_name}`;
        cells[1].textContent = resident.building;
        cells[2].textContent = resident.floor;
        cells[3].textContent = resident.room_number;
        cells[4].textContent = resident.user.email;
      }
    });
  }

  function showSuccessMessage(message) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.setAttribute('role', 'alert');
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('h2').parentElement;
    container.insertAdjacentElement('afterend', alertDiv);
    
    setTimeout(() => alertDiv.remove(), 5000);
  }

  // Close modal when clicking outside
  document.getElementById('residentModalBackdrop').addEventListener('click', closeResidentModal);
</script>
{% endblock %}
