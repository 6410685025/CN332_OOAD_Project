{% extends "base.html" %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto;">
  <div class="d-flex align-items-center gap-2 mb-4">
    <i class="bi bi-gear" style="font-size: 1.5rem;"></i>
    <h2 style="margin: 0;">Settings</h2>
  </div>

  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link active" href="#">Profile</a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-muted" href="#">Security</a>
    </li>
  </ul>

  <div class="card">
    <div class="card-body">
      <!-- User Avatar and Info Section -->
      <div class="d-flex align-items-center gap-4 mb-4 pb-4 border-bottom">
        <div style="position: relative; width: 100px; height: 100px;">
          {% if user.profile_photo %}
            <img id="avatarDisplay" src="{{ user.profile_photo.url }}" 
                 style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #e5e7eb;">
          {% else %}
            <div id="avatarDisplay" 
                 style="width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: bold;">
              {{ user.get_full_name|default:user.username|slice:":1"|upper }}
            </div>
          {% endif %}
          <div style="position: absolute; bottom: 0; right: 0; background: #10b981; width: 28px; height: 28px; border-radius: 50%; 
                      border: 3px solid white; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-check" style="color: white; font-size: 0.8rem;"></i>
          </div>
        </div>
        <div class="flex-grow-1">
          <h5 class="mb-1" id="displayFullName">{{ user.get_full_name|default:user.username }}</h5>
          <small class="text-muted d-block">User ID: RES-2024-001</small>
          <div class="mt-2">
            <span class="badge bg-success" style="font-size: 0.75rem;">● Active</span>
            <span class="badge bg-info ms-2" style="font-size: 0.75rem;">Resident</span>
          </div>
        </div>
        {% if user.is_resident %}
        <button class="btn btn-outline-secondary btn-sm" onclick="openEditProfileModal()">
          <i class="bi bi-pencil me-1"></i>Change Photo
        </button>
        {% endif %}
      </div>

      <!-- Personal Information Section -->
      <h6 class="fw-bold mb-3">Personal Information</h6>
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label text-muted small">Full Name</label>
            <p class="mb-0 fw-semibold" id="displayFullName">{{ user.get_full_name|default:user.username }}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label text-muted small">Email Address</label>
            <p class="mb-0" id="displayEmail">{{ user.email|default:"—" }}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label text-muted small">Phone Number</label>
            <p class="mb-0" id="displayContact">{{ user.contact_number|default:"—" }}</p>
          </div>
        </div>
        {% if user.is_resident %}
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label text-muted small">Date of Birth</label>
            <p class="mb-0">—</p>
          </div>
        </div>
        {% endif %}
      </div>

      {% if user.is_resident and user.resident %}
      <hr>

      <!-- Residence Information Section -->
      <h6 class="fw-bold mb-3">Residence Information</h6>
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="p-3 rounded" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
            <div style="text-align: center;">
              <i class="bi bi-building" style="font-size: 1.5rem; color: #0891b2; display: block; margin-bottom: 8px;"></i>
              <small class="text-muted d-block" style="font-size: 0.75rem;">Building</small>
              <strong style="font-size: 1.1rem; display: block; margin-top: 4px;">{{ user.resident.building }}</strong>
              <span class="badge bg-light text-dark" style="font-size: 0.65rem; margin-top: 8px;">Read Only</span>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 rounded" style="background: linear-gradient(135deg, #f5a3ff 0%, #e0c3fc 100%);">
            <div style="text-align: center;">
              <i class="bi bi-diagram-3" style="font-size: 1.5rem; color: #a855f7; display: block; margin-bottom: 8px;"></i>
              <small class="text-muted d-block" style="font-size: 0.75rem;">Floor</small>
              <strong style="font-size: 1.1rem; display: block; margin-top: 4px;">{{ user.resident.floor }}</strong>
              <span class="badge bg-light text-dark" style="font-size: 0.65rem; margin-top: 8px;">Read Only</span>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 rounded" style="background: linear-gradient(135deg, #a1e969 0%, #81c784 100%);">
            <div style="text-align: center;">
              <i class="bi bi-door-closed" style="font-size: 1.5rem; color: #15803d; display: block; margin-bottom: 8px;"></i>
              <small class="text-muted d-block" style="font-size: 0.75rem;">Room Number</small>
              <strong style="font-size: 1.1rem; display: block; margin-top: 4px;">{{ user.resident.room_number }}</strong>
              <span class="badge bg-light text-dark" style="font-size: 0.65rem; margin-top: 8px;">Read Only</span>
            </div>
          </div>
        </div>
      </div>

      <hr>
      {% endif %}

      <!-- Account & Security Section -->
      <h6 class="fw-bold mb-3">Account & Security</h6>
      <div class="d-flex justify-content-between align-items-center p-3 rounded" 
           style="background: #f0f9ff; cursor: pointer; border: 1px solid #bfdbfe; transition: all 0.2s;"
           onclick="openChangePasswordModal()"
           onmouseover="this.style.background='#e0f2fe'"
           onmouseout="this.style.background='#f0f9ff'">
        <div class="d-flex align-items-center gap-3">
          <div style="width: 40px; height: 40px; background: #06b6d4; border-radius: 8px; 
                      display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-lock" style="color: white; font-size: 1.1rem;"></i>
          </div>
          <div>
            <strong class="d-block">Change Password</strong>
            <small class="text-muted">Last changed 3 months ago</small>
          </div>
        </div>
        <i class="bi bi-chevron-right text-muted"></i>
      </div>

      <hr>

      <!-- Action Buttons -->
      <div class="d-flex gap-2 justify-content-between mt-4">
        <a href="{% url 'logout' %}" class="btn btn-outline-danger">
          <i class="bi bi-box-arrow-right me-2"></i>Log Out
        </a>
        <div>
          <button type="button" class="btn btn-outline-secondary ms-2">Cancel</button>
          <button type="button" class="btn btn-success ms-2" onclick="showAlert('success', 'Changes saved successfully')">
            <i class="bi bi-check me-1"></i>Save Changes
          </button>
        </div>
      </div>

      <div id="successAlert" class="alert alert-success d-none mt-3" role="alert"></div>
      <div id="errorAlert" class="alert alert-danger d-none mt-3" role="alert"></div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Profile</h5>
        <button type="button" class="btn-close" onclick="closeEditProfileModal()"></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="profilePhotoInput" class="form-label">Profile Photo</label>
            <input type="file" class="form-control" id="profilePhotoInput" name="profile_photo" accept="image/*" onchange="previewProfilePhoto(this)">
            <small class="text-muted d-block mt-1">JPG, PNG or GIF (max 5MB)</small>
            <div id="photoPreview" class="mt-2"></div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editFirstName" class="form-label">First Name *</label>
                <input type="text" class="form-control" id="editFirstName" name="first_name" value="{{ user.first_name }}" required>
                <div class="invalid-feedback" id="first_name-error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editLastName" class="form-label">Last Name *</label>
                <input type="text" class="form-control" id="editLastName" name="last_name" value="{{ user.last_name }}" required>
                <div class="invalid-feedback" id="last_name-error"></div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email *</label>
            <input type="email" class="form-control" id="editEmail" name="email" value="{{ user.email }}" required>
            <div class="invalid-feedback" id="email-error"></div>
          </div>
          <div class="mb-3">
            <label for="editContact" class="form-label">Contact Number</label>
            <input type="tel" class="form-control" id="editContact" name="contact_number" value="{{ user.contact_number|default:'' }}">
          </div>
          <div id="profileFormError" class="alert alert-danger d-none" role="alert"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitEditProfileForm()">
          <span id="profileSubmitBtn">Save Changes</span>
          <span id="profileSubmitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="btn-close" onclick="closeChangePasswordModal()"></button>
      </div>
      <div class="modal-body">
        <form id="changePasswordForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="oldPassword" class="form-label">Current Password *</label>
            <input type="password" class="form-control" id="oldPassword" name="old_password" required>
            <div class="invalid-feedback" id="old_password-error"></div>
          </div>
          <div class="mb-3">
            <label for="newPassword1" class="form-label">New Password *</label>
            <input type="password" class="form-control" id="newPassword1" name="new_password1" required>
            <small class="text-muted d-block mt-1">
              • At least 8 characters<br>
              • Mix of letters, numbers, and symbols
            </small>
            <div class="invalid-feedback" id="new_password1-error"></div>
          </div>
          <div class="mb-3">
            <label for="newPassword2" class="form-label">Confirm New Password *</label>
            <input type="password" class="form-control" id="newPassword2" name="new_password2" required>
            <div class="invalid-feedback" id="new_password2-error"></div>
          </div>
          <div id="passwordFormError" class="alert alert-danger d-none" role="alert"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitChangePasswordForm()">
          <span id="passwordSubmitBtn">Change Password</span>
          <span id="passwordSubmitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrops -->
<div id="editProfileBackdrop" class="modal-backdrop fade" style="display: none;"></div>
<div id="changePasswordBackdrop" class="modal-backdrop fade" style="display: none;"></div>

<style>
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100%;
    height: 100%;
    background-color: #000;
    opacity: 0.5;
  }

  .modal {
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal.show {
    display: block;
  }

  .form-label {
    font-weight: 500;
  }
</style>

<script>
  function openEditProfileModal() {
    document.getElementById('editProfileForm').reset();
    document.getElementById('profileFormError').classList.add('d-none');
    document.getElementById('editProfileModal').classList.add('show');
    document.getElementById('editProfileBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function closeEditProfileModal() {
    document.getElementById('editProfileModal').classList.remove('show');
    document.getElementById('editProfileBackdrop').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('photoPreview').innerHTML = '';
  }

  function openChangePasswordModal() {
    document.getElementById('changePasswordForm').reset();
    document.getElementById('passwordFormError').classList.add('d-none');
    document.getElementById('changePasswordModal').classList.add('show');
    document.getElementById('changePasswordBackdrop').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('show');
    document.getElementById('changePasswordBackdrop').style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  function previewProfilePhoto(input) {
    const preview = document.getElementById('photoPreview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.innerHTML = `<img src="${e.target.result}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">`;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function submitEditProfileForm() {
    const form = document.getElementById('editProfileForm');
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    const submitBtn = document.getElementById('profileSubmitBtn');
    const submitSpinner = document.getElementById('profileSubmitSpinner');
    submitBtn.style.display = 'none';
    submitSpinner.classList.remove('d-none');

    const formData = new FormData(form);

    fetch('{% url "update_profile" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeEditProfileModal();
        updateDisplayProfile(data.user);
        showAlert('success', 'Profile updated successfully');
      } else {
        document.getElementById('profileFormError').textContent = data.error || 'An error occurred';
        document.getElementById('profileFormError').classList.remove('d-none');
      }
    })
    .catch(error => {
      document.getElementById('profileFormError').textContent = 'Error: ' + error;
      document.getElementById('profileFormError').classList.remove('d-none');
    })
    .finally(() => {
      submitBtn.style.display = 'inline-block';
      submitSpinner.classList.add('d-none');
    });
  }

  function submitChangePasswordForm() {
    const form = document.getElementById('changePasswordForm');
    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      return;
    }

    const submitBtn = document.getElementById('passwordSubmitBtn');
    const submitSpinner = document.getElementById('passwordSubmitSpinner');
    submitBtn.style.display = 'none';
    submitSpinner.classList.remove('d-none');

    const formData = new FormData(form);

    fetch('{% url "change_password" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeChangePasswordModal();
        showAlert('success', 'Password changed successfully');
      } else {
        document.getElementById('passwordFormError').textContent = data.error || 'An error occurred';
        document.getElementById('passwordFormError').classList.remove('d-none');
      }
    })
    .catch(error => {
      document.getElementById('passwordFormError').textContent = 'Error: ' + error;
      document.getElementById('passwordFormError').classList.remove('d-none');
    })
    .finally(() => {
      submitBtn.style.display = 'inline-block';
      submitSpinner.classList.add('d-none');
    });
  }

  function updateDisplayProfile(user) {
    document.getElementById('displayFullName').textContent = user.first_name + ' ' + user.last_name;
    document.getElementById('displayEmail').textContent = user.email;
    document.getElementById('displayContact').textContent = user.contact_number || '—';
    
    // Update avatar if photo was uploaded
    if (user.profile_photo_url) {
      const avatar = document.getElementById('avatarDisplay');
      avatar.innerHTML = `<img src="${user.profile_photo_url}?t=${new Date().getTime()}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    }
  }

  function showAlert(type, message) {
    const alert = document.getElementById(type + 'Alert');
    alert.textContent = message;
    alert.classList.remove('d-none');
    setTimeout(() => alert.classList.add('d-none'), 4000);
  }

  // Close modals when clicking backdrop
  document.getElementById('editProfileBackdrop').addEventListener('click', closeEditProfileModal);
  document.getElementById('changePasswordBackdrop').addEventListener('click', closeChangePasswordModal);
</script>
{% endblock %}
